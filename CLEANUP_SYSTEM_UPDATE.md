# üóëÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç

## üîÑ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### **–ë—ã–ª–æ:**
- –ü–æ—Ç–æ–∫ –æ—á–∏—Å—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ–º–µ—á–∞–ª –ø–∞—Å—Ç—ã –∫–∞–∫ –∏—Å—Ç–µ–∫—à–∏–µ (`is_expired = True`)
- –ü–∞—Å—Ç—ã –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–≤—Å–µ–≥–¥–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏

### **–°—Ç–∞–ª–æ:**
- **–§–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** –∏—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç –∏–∑ –ë–î –∏ MinIO
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- **–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∏—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç** (–±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤)
- **–†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** —á–µ—Ä–µ–∑ API endpoint
- **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –ø–∞—Å—Ç

## üéØ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### **1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:**
- **–ß–∞—Å—Ç–æ—Ç–∞**: –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (–≤–º–µ—Å—Ç–æ 5 –º–∏–Ω—É—Ç)
- **–î–µ–π—Å—Ç–≤–∏–µ**: —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î –∏ MinIO
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –µ—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å, –ø–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ –∏—Å—Ç–µ–∫—à—É—é
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –æ—á–∏—Å—Ç–∫–∏

### **2. –£–º–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:**
- **–ù–æ–≤—ã–µ –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã**: —É–¥–∞–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É
- **–°—Ç–∞—Ä—ã–µ –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã**: —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- **Fallback**: –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–µ—Ç—Å—è, –ø–∞—Å—Ç–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å—Ç–µ–∫—à–∞—è

### **3. –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:**
- **Endpoint**: `POST /admin/cleanup`
- **–§—É–Ω–∫—Ü–∏—è**: —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: JSON —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–∞—Å—Ç

### **4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
- **–ü—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- **–ê–≤—Ç–æ–º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞**: –ø–∞—Å—Ç—ã –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ –∏—Å—Ç–µ–∫—à–∏–µ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### **–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏:**
```python
def cleanup_expired_pastes():
    """–£–¥–∞–ª—è–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã –∏–∑ –ë–î –∏ MinIO"""
    while True:
        try:
            with app.app_context():
                # –ù–∞—Ö–æ–¥–∏–º –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã (–Ω–µ –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –∏—Å—Ç–µ–∫—à–∏–µ)
                expired_pastes = Paste.query.filter(
                    Paste.expires_at < datetime.now(timezone.utc),
                    Paste.is_expired == False
                ).all()
                
                # –¢–∞–∫–∂–µ –Ω–∞—Ö–æ–¥–∏–º –ø–∞—Å—Ç—ã, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –∏—Å—Ç–µ–∫—à–∏–µ –±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
                old_expired_pastes = Paste.query.filter(
                    Paste.is_expired == True,
                    Paste.expires_at < datetime.now(timezone.utc) - timedelta(hours=24)
                ).all()
                
                # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                pastes_to_delete = expired_pastes + old_expired_pastes
                
                deleted_count = 0
                for paste in pastes_to_delete:
                    try:
                        # –£–¥–∞–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ MinIO
                        storage.delete_paste_content(paste.id, paste.content_hash)
                        
                        # –£–¥–∞–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ MinIO
                        try:
                            storage.delete_paste_metadata(paste.id)
                        except:
                            pass
                        
                        # –£–¥–∞–ª—è–µ–º –ø–∞—Å—Ç—É –∏–∑ –ë–î
                        db.session.delete(paste)
                        deleted_count += 1
                        
                    except Exception as e:
                        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Å—Ç—ã {paste.id}: {e}")
                        paste.is_expired = True
                
                if pastes_to_delete:
                    db.session.commit()
                    print(f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {deleted_count} –∏—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç")
                
            time.sleep(60)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–∞—Å—Ç: {e}")
            time.sleep(60)
```

### **–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ MinioStorage:**
```python
def delete_paste_metadata(self, paste_id: int):
    """–£–¥–∞–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–∞—Å—Ç—ã"""
    try:
        object_name = f"{paste_id}/metadata.json"
        
        # –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç
        self.client.remove_object(self.bucket_name, object_name)
        
        print(f"–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–∞—Å—Ç—ã {paste_id} —É–¥–∞–ª–µ–Ω—ã –∏–∑ MinIO")
        
    except S3Error as e:
        print(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: {e}")
        # –ù–µ –≤—ã–∑—ã–≤–∞–µ–º raise, —Ç–∞–∫ –∫–∞–∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã
```

### **API –¥–ª—è —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:**
```python
@app.route('/admin/cleanup', methods=['POST'])
def manual_cleanup():
    """–†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç"""
    try:
        with app.app_context():
            # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã
            expired_pastes = Paste.query.filter(
                Paste.expires_at < datetime.now(timezone.utc)
            ).all()
            
            deleted_count = 0
            for paste in expired_pastes:
                try:
                    # –£–¥–∞–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ MinIO
                    storage.delete_paste_content(paste.id, paste.content_hash)
                    storage.delete_paste_metadata(paste.id)
                    
                    # –£–¥–∞–ª—è–µ–º –ø–∞—Å—Ç—É –∏–∑ –ë–î
                    db.session.delete(paste)
                    deleted_count += 1
                    
                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Å—Ç—ã {paste.id}: {e}")
            
            if expired_pastes:
                db.session.commit()
                return jsonify({
                    'success': True,
                    'message': f'–£–¥–∞–ª–µ–Ω–æ {deleted_count} –∏—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç'
                })
            else:
                return jsonify({
                    'success': True,
                    'message': '–ò—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
                })
                
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'success': False,
            'error': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: {str(e)}'
        }), 500
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### **–î–ª—è —Å–∏—Å—Ç–µ–º—ã:**
- ‚úÖ **–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç–∞** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ MinIO
- ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ** –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** —Å fallback-–º–µ—Ö–∞–Ω–∏–∑–º–æ–º

### **–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- ‚úÖ **–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è—é—Ç—Å—è
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∏—Å—Ç–µ–∫—à–∏–µ –ø–∞—Å—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å** - –±—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

### **–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:**
- ‚úÖ **–†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
- ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ—á–∏—Å—Ç–∫–∏
- ‚úÖ **–ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** —á–∞—Å—Ç–æ—Ç—ã –æ—á–∏—Å—Ç–∫–∏
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—á–∏—Å—Ç–∫–∏

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### **–õ–æ–≥–∏ –æ—á–∏—Å—Ç–∫–∏:**
- `‚úÖ –£–¥–∞–ª–µ–Ω–æ X –∏—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç` - —É—Å–ø–µ—à–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
- `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–∞—Å—Ç: ...` - –æ–±—â–∏–µ –æ—à–∏–±–∫–∏
- `–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Å—Ç—ã X: ...` - –æ—à–∏–±–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Å—Ç—ã

### **API –æ—Ç–≤–µ—Ç—ã:**
```json
{
    "success": true,
    "message": "–£–¥–∞–ª–µ–Ω–æ 5 –∏—Å—Ç–µ–∫—à–∏—Ö –ø–∞—Å—Ç"
}
```

## üîÆ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### **–í –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö:**
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Å—Ç–æ—Ç—ã –æ—á–∏—Å—Ç–∫–∏** —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –æ—á–∏—Å—Ç–∫–∏
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏** (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–∞—Å—Ç, —Ä–∞–∑–º–µ—Ä –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞)
- **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—á–∏—Å—Ç–∫–∏
- **–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –≤–∞–∂–Ω—ã—Ö –ø–∞—Å—Ç

---

**–£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—á–∏—Å—Ç–∫–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤!** üóëÔ∏è‚ú®
